---
layout: article
title: Vue+auth0ã§ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã¿ã‚‹
tags: Vue.js auth0
aside:
  toc: true
---

## æ¦‚è¦
Vueã¨auth0ã‚’ä½¿ã£ã¦ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã¿ã‚‹ã€‚
Vueã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯2.6.11ã€‚

- ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸
![image](https://user-images.githubusercontent.com/44778704/132944403-2f54e473-5487-4d4c-abab-a0a7f998bff6.png)


- ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸
![image](https://user-images.githubusercontent.com/44778704/135859902-d0055b28-52be-4a34-bc96-c6bcd297e594.png)

- å‚è€ƒ
[Vue.js ã‚’ä½¿ã£ã¦ä½œã£ãŸã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã« Auth0 ã‚’ä½¿ã£ãŸèªè¨¼æ©Ÿèƒ½ã‚’ã¤ã‘ã‚‹](https://blog.serverworks.co.jp/tech/2020/03/31/vue-auth0/)

## æ‰‹é †1 auth0ã®è¨­å®š

- [https://auth0.com/signup](https://auth0.com/signup)ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦auth0ã®ä¼šå“¡ç™»éŒ²ã‚’ã™ã‚‹ã€‚
- ã€Œcreate Applicationã€ã‚’é¸æŠå¾Œã€ã€ŒSingle Page Web Applicationã€ã‚’é¸æŠã—ã¦ã€ŒCreateã€ã‚’æŠ¼ä¸‹ã€‚
- settingsã‚¿ãƒ–ã®ä»¥ä¸‹ã®é …ç›®ã«ã€Œ`http://localhost:8080`ã€ã‚’å…¥åŠ›ã™ã‚‹
  - Allowed Web Origins
  - Allowed Callback URLs
  - Allowed Logout URLs
- settingsã‚¿ãƒ–ã®ä»¥ä¸‹ã®é …ç›®ã‚’æ§ãˆã¦ãŠã
  - Domain
  - Client ID

## æ‰‹é †2 Vueã®è¨­å®š

- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆ

```
vue create auth0
cd auth0
```

Vueã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯`2`ã‚’é¸æŠã™ã‚‹

- authã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```
npm install @auth0/auth0-spa-js
```

- auth_config.jsonã‚’ç”¨æ„

```json
{
  "domain": "ğŸ¤«auth0ã®ç”»é¢ã§ã‚³ãƒ”ãƒ¼ã—ãŸDomain",
  "clientId": "ğŸ¤«auth0ã®ç”»é¢ã§ã‚³ãƒ”ãƒ¼ã—ãŸClientId"
}
```

- src/auth/index.vueã‚’ç”¨æ„

```js
import Vue from 'vue';
import createAuth0Client from '@auth0/auth0-spa-js';

/** Define a default action to perform after authentication */
const DEFAULT_REDIRECT_CALLBACK = () =>
  window.history.replaceState({}, document.title, window.location.pathname);

let instance;

/** Returns the current instance of the SDK */
export const getInstance = () => instance;

/** Creates an instance of the Auth0 SDK. If one has already been created, it returns that instance */
export const useAuth0 = ({
  onRedirectCallback = DEFAULT_REDIRECT_CALLBACK,
  redirectUri = window.location.origin,
  ...options
}) => {
  if (instance) return instance;

  // The 'instance' is simply a Vue object
  instance = new Vue({
    data() {
      return {
        loading: true,
        isAuthenticated: false,
        user: {},
        auth0Client: null,
        popupOpen: false,
        error: null,
      };
    },
    methods: {
      /** Authenticates the user using a popup window */
      async loginWithPopup(o) {
        this.popupOpen = true;

        try {
          await this.auth0Client.loginWithPopup(o);
        } catch (e) {
          // eslint-disable-next-line
          console.error(e);
        } finally {
          this.popupOpen = false;
        }

        this.user = await this.auth0Client.getUser();
        this.isAuthenticated = true;
      },
      /** Handles the callback when logging in using a redirect */
      async handleRedirectCallback() {
        this.loading = true;
        try {
          await this.auth0Client.handleRedirectCallback();
          this.user = await this.auth0Client.getUser();
          this.isAuthenticated = true;
        } catch (e) {
          this.error = e;
        } finally {
          this.loading = false;
        }
      },
      /** Authenticates the user using the redirect method */
      loginWithRedirect(o) {
        return this.auth0Client.loginWithRedirect(o);
      },
      /** Returns all the claims present in the ID token */
      getIdTokenClaims(o) {
        return this.auth0Client.getIdTokenClaims(o);
      },
      /** Returns the access token. If the token is invalid or missing, a new one is retrieved */
      getTokenSilently(o) {
        return this.auth0Client.getTokenSilently(o);
      },
      /** Gets the access token using a popup window */

      getTokenWithPopup(o) {
        return this.auth0Client.getTokenWithPopup(o);
      },
      /** Logs the user out and removes their session on the authorization server */
      logout(o) {
        return this.auth0Client.logout(o);
      },
    },
    /** Use this lifecycle method to instantiate the SDK client */
    async created() {
      // Create a new instance of the SDK client using members of the given options object
      this.auth0Client = await createAuth0Client({
        domain: options.domain,
        client_id: options.clientId,
        audience: options.audience,
        redirect_uri: redirectUri,
      });

      try {
        // If the user is returning to the app after authentication..
        if (
          window.location.search.includes('code=') &&
          window.location.search.includes('state=')
        ) {
          // handle the redirect and retrieve tokens
          const { appState } = await this.auth0Client.handleRedirectCallback();

          // Notify subscribers that the redirect callback has happened, passing the appState
          // (useful for retrieving any pre-authentication state)
          onRedirectCallback(appState);
        }
      } catch (e) {
        this.error = e;
      } finally {
        // Initialize our internal authentication state
        this.isAuthenticated = await this.auth0Client.isAuthenticated();
        this.user = await this.auth0Client.getUser();
        this.loading = false;
      }
    },
  });

  return instance;
};

// Create a simple Vue plugin to expose the wrapper object throughout the application
export const Auth0Plugin = {
  install(Vue, options) {
    Vue.prototype.$auth = useAuth0(options);
  },
};

```


- src/App.vueã‚’ä¿®æ­£

```html
<template>
  <div id="app">
    <img alt="Vue logo" src="./assets/logo.png" />
    <div v-if="!$auth.loading">
      <button v-if="!$auth.isAuthenticated" @click="login">Log in</button>
      <div v-if="$auth.isAuthenticated">
        <button @click="logout">Log out</button>
        <h2>{{ $auth.user.name }}</h2>
        <p>{{ $auth.user.email }}</p>
      </div>
    </div>
  </div>
</template>

<script>
export default {
  name: "App",
  components: {},
  methods: {
    // Login
    login() {
      this.$auth.loginWithRedirect();
    },
    // Logout
    logout() {
      this.$auth.logout({
        returnTo: window.location.origin,
      });
    },
  },
};
</script>

<style>
#app {
  font-family: Avenir, Helvetica, Arial, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  text-align: center;
  color: #2c3e50;
  margin-top: 60px;
}
</style>
```

## æŒ™å‹•ã®ç¢ºèª

- ä»¥ä¸‹ã‚’å®Ÿè¡Œ

```
npm run serve
```

localhost:8080ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€authã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã€‚

## ãƒ¦ãƒ‹ãƒãƒ¼ã‚µãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³ã®è¨­å®š
ã¡ã‚‡ã£ã¨å‘³æ°—ãªã„ã®ã§ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’å°‘ã—å¤‰æ›´ã—ã¦ã¿ã‚‹ã€‚
- auth0ã®Brandingãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
![image](https://user-images.githubusercontent.com/44778704/132945927-39486b1c-c3ae-4d46-80d1-0a39a963ce70.png)

- Loginã‚¿ãƒ–ã®ã€ŒDefault Templatesã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã€ŒCustom Login Formã€ã‚’é¸æŠ
ä¸‹ã®ã‚½ãƒ¼ã‚¹ç”»é¢ã«htmlãŒè¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ãã“ã‚’ã„ã˜ãã‚‹

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Sign In with Auth0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
</head>
  <style>
    body, html {
      height: 100%;
      /* èƒŒæ™¯è‰²ã®å¤‰æ›´ */
      background-color: thistle;
    }

    .login-container {
      position: relative;
      height: 100%;
    }

    .login-box {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      padding: 15px;
      background-color: #fff;
      box-shadow: 0px 5px 5px #ccc;
      border-radius: 5px;
      border-top: 1px solid #e9e9e9;
    }

    .login-header {
      text-align: center;
    }

    .login-header img {
      width: 75px;
    }

    #error-message {
      display: none;
      white-space: break-spaces;
    }
  </style>
<body>
  <div class="login-container">
    <div class="col-xs-12 col-sm-4 col-sm-offset-4 login-box">
      <div class="login-header">
        <!-- TOPç”»åƒã®å¤‰æ›´ -->
        <img src="https://my-public-bucket---1.s3.ap-northeast-1.amazonaws.com/girl_icon.png"/>

        <!-- ã“ã®è¾ºã‚’æ—¥æœ¬èªã«æ›¸ãã‹ãˆã‚‹ -->
        <h3>ã‚ˆã†ã“ã</h3>
        <h5>ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</h5>
      </div>
      <div id="error-message" class="alert alert-danger"></div>
      <form onsubmit="return false;" method="post">
        <div class="form-group">
         <label for="name">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
          <input
            type="email"
            class="form-control"
            id="email"
            placeholder="ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
        </div>
        <div class="form-group">
          <label for="name">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
          <input
            type="password"
            class="form-control"
            id="password"
            placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
        </div>
        <div class="captcha-container form-group"></div>
        <button
          type="submit"
          id="btn-login"
          class="btn btn-primary btn-block">
            ãƒ­ã‚°ã‚¤ãƒ³
        </button>
        <button
          type="button"
          id="btn-signup"
          class="btn btn-default btn-block">
            æ–°è¦ç™»éŒ²
        </button>
        <hr>
        <button
          type="button"
          id="btn-google"
          class="btn btn-default btn-danger btn-block">
            Log In with Google
        </button>
      </form>
    </div>
  </div>

  <!--[if IE 8]>
  <script src="//cdnjs.cloudflare.com/ajax/libs/ie8/0.2.5/ie8.js"></script>
  <![endif]-->

  <!--[if lte IE 9]>
  <script src="https://cdn.auth0.com/js/polyfills/1.0/base64.min.js"></script>
  <script src="https://cdn.auth0.com/js/polyfills/1.0/es5-shim.min.js"></script>
  <![endif]-->

  <script src="https://cdn.auth0.com/js/auth0/9.16/auth0.min.js"></script>
  <script src="https://cdn.auth0.com/js/polyfills/1.0/object-assign.min.js"></script>
  <script>
   // ç•¥
  </script>
</body>
</html>
```

Previewã‚¿ãƒ–ã‚’æŠ¼ã›ã°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¦‹ã‚Œã‚‹

ä»¥ä¸Šã€‚

